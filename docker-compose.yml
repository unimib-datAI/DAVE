version: "3"
services:
  postgres:
    restart: $RESTART_POLICY
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-keycloak}
    volumes:
      - ./postgres/data:/var/lib/postgresql/data
    networks:
      - dave_net
    ports:
      - 127.0.0.1:5432:5432

  keycloak:
    restart: $RESTART_POLICY
    image: quay.io/keycloak/keycloak:23.0
    command: start-dev
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-keycloak}
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      KC_HOSTNAME_STRICT: false
      KC_HOSTNAME_STRICT_HTTPS: false
      KC_HTTP_ENABLED: true
      KC_HEALTH_ENABLED: true
      KC_METRICS_ENABLED: true
      KC_HOSTNAME: localhost
      KC_HOSTNAME_PORT: 8080
    depends_on:
      - postgres
    ports:
      - 0.0.0.0:${KEYCLOAK_PORT:-8080}:8080
    networks:
      - dave_net

  mongo:
    restart: $RESTART_POLICY
    image: mongo:4.4.6 # mongo 5 requires cpu supports AVX
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: $MONGO_ROOT_PASSWORD
      MONGO_INITDB_DATABASE: main
      MONGO_INITDB_USERNAME: usr
      MONGO_INITDB_PASSWORD: $MONGO_PASSWORD
      MONGO: $MONGO
    volumes:
      - ./mongo/data:/data/db
      - ./mongo/initdb.d:/docker-entrypoint-initdb.d/
    ports:
      - 127.0.0.1:27018:27017
    networks:
      - dave_net

  documents:
    restart: $RESTART_POLICY
    build: ./backend/documents
    environment:
      DOCS_PORT: 3001
      ENABLE_AUTH: true
      USE_KEYCLOAK: ${USE_KEYCLOAK:-true}
      KEYCLOAK_ISSUER: ${KEYCLOAK_ISSUER:-http://keycloak:8080/realms/DAVE}
      KEYCLOAK_ID: ${KEYCLOAK_ID:-dave_client}
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      JWT_SECRET: ${DOCUMENTS_JWT_SECRET:-your-secret-key-change-in-production}
      MONGO: $MONGO
      ANONYMIZATION_ENDPOINT: $ANONYMIZATION_ENDPOINT
      ANNOTATION_SPACYNER_URL: $ANNOTATION_SPACYNER_URL
      ANNOTATION_BLINK_URL: $ANNOTATION_BLINK_URL
      ANNOTATION_INDEXER_URL: $ANNOTATION_INDEXER_URL
      ANNOTATION_NILPREDICTION_URL: $ANNOTATION_NILPREDICTION_URL
      ANNOTATION_NILCLUSTER_URL: $ANNOTATION_NILCLUSTER_URL
      ANNOTATION_CONSOLIDATION_URL: $ANNOTATION_CONSOLIDATION_URL
    networks:
      - dave_net
    volumes:
      - ./backend/documents/src:/app/src
    ports:
      - 3001:3001

  ui:
    restart: $RESTART_POLICY
    build:
      context: ./frontend
      args:
        ACCESS_USERNAME: $ACCESS_USERNAME
        ACCESS_PASSWORD: $ACCESS_PASSWORD
        API_BASE_URI: $API_BASE_URI
        API_USERNAME: $API_USERNAME
        API_PASSWORD: $API_PASSWORD
        NEXTAUTH_SECRET: $NEXTAUTH_SECRET
        NEXTAUTH_URL: $NEXTAUTH_URL
        NEXT_PUBLIC_BASE_PATH: $NEXT_PUBLIC_BASE_PATH
        NEXT_PUBLIC_FULL_PATH: $NEXT_PUBLIC_FULL_PATH
        KEYCLOAK_ID: $KEYCLOAK_ID
        KEYCLOAK_SECRET: $KEYCLOAK_SECRET
        KEYCLOAK_ISSUER: $KEYCLOAK_ISSUER
        API_LLM: $API_LLM
        API_INDEXER: $API_INDEXER
        VARIANT: $VARIANT
        TEXT_GENERATION: $TEXT_GENERATION
        ELASTIC_INDEX: $ELASTIC_INDEX
    ports:
      - $LISTEN_UI:3000
      - 127.0.0.1:9229:9229
    networks:
      - dave_net
    environment:
      ACCESS_USERNAME: $ACCESS_USERNAME
      ACCESS_PASSWORD: $ACCESS_PASSWORD
      API_BASE_URI: $API_BASE_URI
      API_USERNAME: $API_USERNAME
      API_PASSWORD: $API_PASSWORD
      NEXTAUTH_SECRET: $NEXTAUTH_SECRET
      NEXTAUTH_URL: $NEXTAUTH_URL
      NEXT_PUBLIC_BASE_PATH: $NEXT_PUBLIC_BASE_PATH
      NEXT_PUBLIC_FULL_PATH: $NEXT_PUBLIC_FULL_PATH
      KEYCLOAK_ID: $KEYCLOAK_ID
      KEYCLOAK_SECRET: $KEYCLOAK_SECRET
      KEYCLOAK_ISSUER: $KEYCLOAK_ISSUER
      API_LLM: $API_LLM
      API_INDEXER: $API_INDEXER
      VARIANT: $VARIANT
      TEXT_GENERATION: $TEXT_GENERATION
      HOST: $HOST
      ELASTIC_INDEX: $ELASTIC_INDEX
      ANNOTATION_SPACYNER_URL: $ANNOTATION_SPACYNER_URL
      ANNOTATION_BLINK_URL: $ANNOTATION_BLINK_URL
      ANNOTATION_INDEXER_URL: $ANNOTATION_INDEXER_URL
      ANNOTATION_NILPREDICTION_URL: $ANNOTATION_NILPREDICTION_URL
      ANNOTATION_NILCLUSTER_URL: $ANNOTATION_NILCLUSTER_URL
      ANNOTATION_CONSOLIDATION_URL: $ANNOTATION_CONSOLIDATION_URL
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./frontend/modules:/app/modules
      - ./frontend/server:/app/server
      - ./frontend/pages:/app/pages
      - ./frontend/components:/app/components
      - ./frontend/lib:/app/lib
      - ./frontend/package.json:/app/package.json

  text-generation:
    build:
      context: ./backend/text-generation
      dockerfile: Dockerfile
    environment:
      - HOST=0.0.0.0
      - TEXT_GENERATION_ADDR=${TEXT_GENERATION_ADDR:-http://localhost:8000}
      - TEXT_GENERATION_KEY=${TEXT_GENERATION_KEY:-your-key}
      - MODEL_NAME=${MODEL_NAME:-default-model}
    ports:
      - 7862:7862
      - 8000:8000
    networks:
      - dave_net
    volumes:
      - ./models/text-generation:/workspace/models
      - /mnt/data:/models

  es:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.13.3
    restart: $RESTART_POLICY
    environment:
      - xpack.security.enabled=false
      ### Avoid test failures due to small disks. NOT SUITABLE FOR PRODUCTION.
      - cluster.routing.allocation.disk.threshold_enabled=false
      - cluster.routing.allocation.disk.watermark.low=3mb
      - cluster.routing.allocation.disk.watermark.high=2mb
      - cluster.routing.allocation.disk.watermark.flood_stage=1mb
      - cluster.info.update.interval=1m
      ###
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms4096m -Xmx2048m
      - http.max_content_length=200mb
    networks:
      - dave_net
    ports:
      - 9200:9200
    volumes:
      - ./elasticsearch/data:/usr/share/elasticsearch/data

  qavectorizer:
    build:
      context: ./backend/qavectorizer
      dockerfile: Dockerfile
    # depends_on:
    #   - es
    restart: $RESTART_POLICY
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      - HOST_BASE_URL=${HOST_BASE_URL}
      - INDEXER_SERVER_PORT=7863
      - DOCS_PORT=${DOCS_PORT}
      - CHROMA_PORT=${CHROMA_PORT}
      - ELASTIC_PORT=${ELASTIC_PORT}
      - SENTENCE_TRANSFORMER_EMBEDDING_MODEL=${SENTENCE_TRANSFORMER_EMBEDDING_MODEL}
      - SENTENCE_TRANSFORMER_DEVICE=${SENTENCE_TRANSFORMER_DEVICE}
      - OGG2NAME_INDEX=${OGG2NAME_INDEX}
      # NVIDIA_VISIBLE_DEVICES removed - auto-detection will handle GPU availability
    ports:
      - ${QAVECTORIZER_ADDR}:7863
    networks:
      - dave_net
    volumes:
      - ./backend/qavectorizer/src:/workspace
      - ./backend/models:/root/models
      - ./backend/models/qavectorizer:/root/.cache/huggingface
networks:
  dave_net:
    driver: bridge
